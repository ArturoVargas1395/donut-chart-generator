<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Completion Ratio Donut Chart</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <div class="container">
        <h1>Completion Ratio Donut Chart</h1>

        <div class="chart-container">
            <div class="donut-chart" id="donutChart" style="
                width: 400px;
                height: 400px;
                border-radius: 50%;
                background: conic-gradient(
                    {{ data.completed_color }} 0deg {{ data.completed_degrees }}deg,
                    {{ data.incomplete_color }} {{ data.completed_degrees }}deg 360deg
                );
                display: flex;
                align-items: center;
                justify-content: center;
                position: relative;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            ">
                <div class="donut-hole" style="
                    width: 220px;
                    height: 220px;
                    background: white;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    position: absolute;
                ">
                    <div class="donut-text" id="donutText" style="
                        font-size: 48px;
                        font-weight: 700;
                        color: {{ data.text_color }};
                        font-family: 'Inter', sans-serif;
                    ">
                        {{ "%.2f"|format(data.current) }}/{{ "%.0f"|format(data.max) }}
                    </div>
                </div>
            </div>

            <div class="stats">
                <p><strong>Completion:</strong> {{ "%.1f"|format(data.percentage) }}%</p>
                <p><strong>Completed:</strong> {{ "%.2f"|format(data.current) }}</p>
                <p><strong>Remaining:</strong> {{ "%.2f"|format(data.max - data.current) }}</p>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button onclick="downloadChart()" style="
                    padding: 12px 24px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
                ">ðŸ“¥ Download as PNG (Transparent)</button>
            </div>
        </div>

        <div class="controls">
            <h2>Update Values</h2>
            <form method="POST" action="/update">
                <div class="form-group">
                    <label for="current">Current Value (Completed):</label>
                    <input type="number" id="current" name="current" value="{{ data.current }}" step="0.01" min="0"
                        max="{{ data.max }}" required>
                </div>

                <div class="form-group">
                    <label for="max">Maximum Value:</label>
                    <input type="number" id="max" name="max" value="{{ data.max }}" step="0.01" min="0.01" required>
                </div>

                <div class="form-group">
                    <label for="completed_color">Completed Color:</label>
                    <input type="color" id="completed_color" name="completed_color" value="{{ data.completed_color }}">
                    <input type="text" class="color-text" value="{{ data.completed_color }}" readonly>
                </div>

                <div class="form-group">
                    <label for="incomplete_color">Incomplete Color (Remaining):</label>
                    <input type="color" id="incomplete_color" name="incomplete_color"
                        value="{{ data.incomplete_color }}">
                    <input type="text" class="color-text" value="{{ data.incomplete_color }}" readonly>
                </div>

                <div class="form-group">
                    <label for="text_color">Text Color (Center Numbers):</label>
                    <input type="color" id="text_color" name="text_color" value="{{ data.text_color }}">
                    <input type="text" class="color-text" value="{{ data.text_color }}" readonly>
                </div>

                <button type="submit">Update Chart</button>
            </form>
        </div>
    </div>

    <script>
        // Chart data from server
        var chartData = {
            current: parseFloat('{{ data.current }}'),
            max: parseFloat('{{ data.max }}'),
            completedDegrees: parseFloat('{{ data.completed_degrees }}'),
            completedColor: '{{ data.completed_color }}',
            incompleteColor: '{{ data.incomplete_color }}',
            textColor: '{{ data.text_color }}'
        };

        // Download chart as transparent PNG
        function downloadChart() {
            var canvas = document.createElement('canvas');
            var ctx = canvas.getContext('2d');
            var size = 400;
            canvas.width = size;
            canvas.height = size;

            var centerX = size / 2;
            var centerY = size / 2;
            var outerRadius = 150;
            var innerRadius = 110;

            // Draw completed portion
            ctx.beginPath();
            ctx.arc(centerX, centerY, outerRadius, -Math.PI / 2, (-Math.PI / 2) + (chartData.completedDegrees * Math.PI / 180));
            ctx.arc(centerX, centerY, innerRadius, (-Math.PI / 2) + (chartData.completedDegrees * Math.PI / 180), -Math.PI / 2, true);
            ctx.closePath();
            ctx.fillStyle = chartData.completedColor;
            ctx.fill();

            // Draw incomplete portion
            ctx.beginPath();
            ctx.arc(centerX, centerY, outerRadius, (-Math.PI / 2) + (chartData.completedDegrees * Math.PI / 180), (-Math.PI / 2) + (2 * Math.PI));
            ctx.arc(centerX, centerY, innerRadius, (-Math.PI / 2) + (2 * Math.PI), (-Math.PI / 2) + (chartData.completedDegrees * Math.PI / 180), true);
            ctx.closePath();
            ctx.fillStyle = chartData.incompleteColor;
            ctx.fill();

            // Draw text
            ctx.fillStyle = chartData.textColor;
            ctx.font = 'bold 48px Inter, sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            var text = chartData.current.toFixed(2) + '/' + chartData.max.toFixed(0);
            ctx.fillText(text, centerX, centerY);

            // Download
            canvas.toBlob(function (blob) {
                var url = URL.createObjectURL(blob);
                var link = document.createElement('a');
                link.download = 'donut-chart-' + chartData.current.toFixed(2) + '-' + chartData.max.toFixed(0) + '.png';
                link.href = url;
                link.click();
                URL.revokeObjectURL(url);
            });
        }

        // Update color text inputs when color pickers change
        document.getElementById('completed_color').addEventListener('input', function (e) {
            this.nextElementSibling.value = e.target.value.toUpperCase();
        });

        document.getElementById('incomplete_color').addEventListener('input', function (e) {
            this.nextElementSibling.value = e.target.value.toUpperCase();
        });

        document.getElementById('text_color').addEventListener('input', function (e) {
            this.nextElementSibling.value = e.target.value.toUpperCase();
        });
    </script>
</body>

</html>