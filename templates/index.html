<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donut Chart Generator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Donut Chart Generator</h1>

        <div class="chart-container">
            {% if data.chart_type == "battery" %}
            <div class="battery">
                <div class="battery-fill" style="width: {{ data.percentage if data.percentage <= 100 else 100 }}%; background: {{ data.completed_color }};"></div>
                <div class="battery-text" style="color: {{ data.text_color }}; font-size: {{ data.font_size }}px;">
                    {{ data.formatted_completion }}
                </div>
            </div>
            {% else %}
            <svg width="260" height="260" viewBox="0 0 260 260">
                <circle
                    cx="130"
                    cy="130"
                    r="90"
                    fill="none"
                    stroke="{{ data.incomplete_color }}"
                    stroke-width="18"
                    opacity="0.2" />
                <circle
                    class="progress-ring"
                    cx="130"
                    cy="130"
                    r="90"
                    fill="none"
                    stroke="{{ data.completed_color }}"
                    stroke-width="18"
                    stroke-linecap="round"
                    stroke-dasharray="{{ data.completed_length }} {{ data.circumference }}"
                    transform="rotate(-90 130 130)" />
                <text
                    x="50%"
                    y="50%"
                    text-anchor="middle"
                    dominant-baseline="middle"
                    class="ratio-text"
                    fill="{{ data.text_color }}"
                    style="font-size: {{ data.font_size }}px;">
                    {{ data.formatted_completion }}
                </text>
            </svg>
            {% endif %}

            <div class="stats">
                <p><strong>Current:</strong> {{ data.formatted_current }}</p>
                <p><strong>Max:</strong> {{ data.formatted_max }}</p>
                <p><strong>Completion:</strong> {{ data.formatted_completion }}</p>
            </div>
        </div>

        <form class="controls" method="post" action="{{ url_for('update') }}">
            <h2>Values</h2>
            <div class="form-group">
                <label for="current">Current value</label>
                <input type="number" step="0.01" id="current" name="current" value="{{ data.current }}">
            </div>
            <div class="form-group">
                <label for="max">Max value</label>
                <input type="number" step="0.01" id="max" name="max" value="{{ data.max }}">
            </div>

            <h2>Colors</h2>
            <div class="form-group color-row">
                <label for="completed_color">Completed</label>
                <div class="color-inline">
                    <input type="color" id="completed_color_picker" value="{{ data.completed_color }}">
                    <input class="color-text" type="text" id="completed_color" name="completed_color" value="{{ data.completed_color }}">
                </div>
            </div>
            <div class="form-group color-row">
                <label for="incomplete_color">Incomplete</label>
                <div class="color-inline">
                    <input type="color" id="incomplete_color_picker" value="{{ data.incomplete_color }}">
                    <input class="color-text" type="text" id="incomplete_color" name="incomplete_color" value="{{ data.incomplete_color }}">
                </div>
            </div>
            <div class="form-group color-row">
                <label for="text_color">Text</label>
                <div class="color-inline">
                    <input type="color" id="text_color_picker" value="{{ data.text_color }}">
                    <input class="color-text" type="text" id="text_color" name="text_color" value="{{ data.text_color }}">
                </div>
            </div>

            <h2>Chart options</h2>
            <div class="form-group">
                <label for="chart_type">Chart type</label>
                <select id="chart_type" name="chart_type">
                    <option value="donut" {% if data.chart_type == "donut" %}selected{% endif %}>Donut</option>
                    <option value="battery" {% if data.chart_type == "battery" %}selected{% endif %}>Battery</option>
                </select>
            </div>
            <div class="form-group">
                <label for="font_size">Center text size (px)</label>
                <input type="number" id="font_size" name="font_size" value="{{ data.font_size }}" min="16" max="96">
            </div>

            <h2>Number format</h2>
            <div class="form-group">
                <label for="number_format">Format</label>
                <select id="number_format" name="number_format">
                    <option value="general" {% if data.number_format == "general" %}selected{% endif %}>General</option>
                    <option value="number" {% if data.number_format == "number" %}selected{% endif %}>Number</option>
                    <option value="percentage" {% if data.number_format == "percentage" %}selected{% endif %}>Percentage</option>
                    <option value="currency" {% if data.number_format == "currency" %}selected{% endif %}>Currency</option>
                    <option value="custom" {% if data.number_format == "custom" %}selected{% endif %}>Custom</option>
                </select>
            </div>

            <div class="form-group">
                <label>Decimal places</label>
                <div class="decimal-controls">
                    <input type="hidden" id="decimal_places" name="decimal_places" value="{{ data.decimal_places }}">
                    <button type="button" class="pill-button" id="decrement-decimals">.0â€’</button>
                    <div class="decimal-display" id="decimal_display">{{ data.decimal_places }}</div>
                    <button type="button" class="pill-button" id="increment-decimals">+.0</button>
                </div>
                <p class="helper-text">Clamp between 0 and 4. Affects display only.</p>
            </div>

            <div class="form-group inline-group">
                <label class="inline-label">
                    <input type="checkbox" name="use_thousands" id="use_thousands" {% if data.use_thousands %}checked{% endif %}>
                    Use thousands separator (,)
                </label>
            </div>

            <div class="form-group" id="currency_row">
                <label for="currency_symbol">Currency symbol</label>
                <input type="text" id="currency_symbol" name="currency_symbol" maxlength="3" value="{{ data.currency_symbol }}" placeholder="$">
                <p class="helper-text">Only used when format = Currency.</p>
            </div>

            <button type="submit">Update Chart</button>
        </form>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", () => {
        const decimalInput = document.getElementById("decimal_places");
        const decimalDisplay = document.getElementById("decimal_display");
        const incBtn = document.getElementById("increment-decimals");
        const decBtn = document.getElementById("decrement-decimals");
        const formatSelect = document.getElementById("number_format");
        const currencyRow = document.getElementById("currency_row");
        const colorPairs = [
            ["completed_color_picker", "completed_color"],
            ["incomplete_color_picker", "incomplete_color"],
            ["text_color_picker", "text_color"],
        ];

        // Keep color inputs (picker + text) in sync
        colorPairs.forEach(([pickerId, textId]) => {
            const picker = document.getElementById(pickerId);
            const text = document.getElementById(textId);
            if (!picker || !text) return;

            picker.addEventListener("input", () => {
                text.value = picker.value;
            });
            text.addEventListener("input", () => {
                if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(text.value.trim())) {
                    picker.value = text.value.trim();
                }
            });
        });

        const clamp = (val) => Math.min(4, Math.max(0, val));
        const setDecimals = (val) => {
            const clamped = clamp(val);
            decimalInput.value = clamped;
            decimalDisplay.textContent = clamped;
        };

        incBtn.addEventListener("click", () => {
            setDecimals(parseInt(decimalInput.value || "0", 10) + 1);
        });
        decBtn.addEventListener("click", () => {
            setDecimals(parseInt(decimalInput.value || "0", 10) - 1);
        });

        const toggleCurrency = () => {
            const isCurrency = formatSelect.value === "currency";
            currencyRow.style.display = isCurrency ? "block" : "none";
            const input = currencyRow.querySelector("input");
            input.disabled = !isCurrency;
        };
        formatSelect.addEventListener("change", toggleCurrency);
        toggleCurrency();
    });
    </script>
</body>
</html>
